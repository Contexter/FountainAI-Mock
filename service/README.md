# FountainAI Mock Server Development Plan (Dockerized Workflow)

## Introduction

This development plan outlines a **specification-driven approach** for implementing the **FountainAI Mock Server API** as a **FastAPI** application within a fully **Dockerized** local development environment. The Mock Server simulates various FountainAI services by providing endpoints defined in the unified **OpenAPI specification**. This specification is generated by merging multiple service-specific OpenAPI files using the [`merge_openapi.py` script](https://github.com/Contexter/FountainAI-Mock/blob/main/merge_openapi.py).

The comprehensive documentation for `merge_openapi.py` can be found [here](https://github.com/Contexter/FountainAI/blob/main/openAPI/v4/merge/Comprehensive%20Documentation%20and%20Tutorial%20for%20merge_openapi.py.md).

## Project Organization and Script Management

To maintain a consistent and organized **project structure**, the repository follows a standardized **folder layout** with a clear **root directory** and explicitly defined **paths**. The root directory of the project is `/service`.

### Project Structure

```
/service
├── README.md
├── openapi/                             # Directory containing individual OpenAPI files
│   ├── Action-Service.yml
│   ├── Character-Service.yml
│   ├── ...                              # Other service-specific OpenAPI files
│   └── merged_openapi.yml               # Unified OpenAPI specification (generated)
├── merge_openapi.py                     # Script to merge OpenAPI files
├── run_setup.sh                         # Shell script to automate Docker build and setup
├── scripts/
│   ├── generate_dockerfile.py           # Script to generate the Dockerfile
│   ├── create_directory_structure.py    # Script to create project directories and initial files
│   ├── generate_minimal_main.py         # Script to create a minimal main.py for FastAPI
│   ├── generate_openapi_parser.py       # Script to create an OpenAPI parser module
│   ├── generate_schemas.py              # Script to generate Pydantic schemas from OpenAPI spec
│   ├── generate_api_routes.py           # Script to create FastAPI route files from OpenAPI spec
│   ├── setup_mock_server.py             # Master script to orchestrate setup by running all other scripts
│   └── ...                              # Placeholder for additional scripts
└── app/
    ├── api/
    │   └── routes/                      # FastAPI route files
    ├── core/
    │   └── openapi_parser.py            # OpenAPI parser module
    ├── schemas/                         # Pydantic schemas for request and response validation
    ├── main.py                          # FastAPI main application file
    └── ...                              # Placeholder for additional application modules
```

## Implementation Using Modular Scripts

### Overview

The development workflow utilizes **modular Python scripts** placed within the `/service/scripts/` directory. Each script performs a specific task, contributing to the overall setup of the Mock Server. The `setup_mock_server.py` script orchestrates the execution of all these scripts in the correct order.

Below is a detailed description of each script, including its purpose and the prompt that defines its functionality.

### 1. merge_openapi.py

**Description:**

This script merges multiple service-specific OpenAPI YAML files located in `/service/openapi/` into a single unified OpenAPI specification (`merged_openapi.yml`). The merged specification serves as the source of truth for generating the Mock Server API.

**Reference:**

- [`merge_openapi.py`](https://github.com/Contexter/FountainAI-Mock/blob/main/merge_openapi.py)
- [Comprehensive Documentation](https://github.com/Contexter/FountainAI/blob/main/openAPI/v4/merge/Comprehensive%20Documentation%20and%20Tutorial%20for%20merge_openapi.py.md)

**Prompt:**

> Use the `merge_openapi.py` script to merge individual OpenAPI YAML files in the `/service/openapi/` directory into a single `merged_openapi.yml` file. Ensure the merged specification is validated and serves as the definitive OpenAPI document for the Mock Server.

### 2. generate_dockerfile.py

**Description:**

This script generates a `Dockerfile` in the `/service` root directory, setting up the **Docker environment** with the necessary configurations for the **FastAPI application**.

**Prompt:**

> Generate a script named `generate_dockerfile.py` that creates a `Dockerfile` in the `/service` root directory. The Dockerfile should:

> - Use an official Python base image (e.g., `python:3.11-slim`).
> - Set the working directory to `/service`.
> - Install required system packages.
> - Copy the application code, scripts, and `merged_openapi.yml` into the container.
> - Install Python dependencies using `pip`.
> - Expose the necessary port (`8000`).
> - Set environment variables as needed.
> - Specify the command to run the **FastAPI application** using **Uvicorn**.

### 3. create_directory_structure.py

**Description:**

This script creates the necessary **directories** and **initial files** for the Mock Server relative to the `/service` root directory, ensuring a minimal but functional **FastAPI application** setup.

**Prompt:**

> Generate a script named `create_directory_structure.py` that creates the necessary directories and initial files for the Mock Server relative to the `/service` root directory. It should create:

> - Directories: `/service/app/`, `/service/app/api/routes/`, `/service/app/core/`, `/service/app/schemas/`.
> - Initial files: Minimal `main.py`, `__init__.py` files, and a basic root endpoint.

### 4. generate_minimal_main.py

**Description:**

This script generates a **minimal `main.py`** in `/service/app/` to ensure that the FastAPI application can run independently. This minimal setup includes the FastAPI instance and a simple root endpoint.

**Prompt:**

> Generate a script named `generate_minimal_main.py` that creates a minimal `/service/app/main.py` with a basic FastAPI app instance and a simple root endpoint (`/`).

### 5. generate_openapi_parser.py

**Description:**

This script creates an **OpenAPI parser module** in `/service/app/core/openapi_parser.py` that can be imported by other scripts to facilitate the parsing of the unified OpenAPI specification (`merged_openapi.yml`).

**Prompt:**

> Generate a script named `generate_openapi_parser.py` that creates `/service/app/core/openapi_parser.py`. This module should contain a reusable **OpenAPI parser** class or functions to parse the unified OpenAPI specification located at `/service/openapi/merged_openapi.yml`. The parser should extract:

> - **Schemas**
> - **Paths**
> - **Parameters**
> - **Responses**
> - **Request bodies**
> - **Tags**
> - **Operation IDs**
> - **Server information**
> - **Security requirements**

### 6. generate_schemas.py

**Description:**

This script creates **Pydantic models** in `/service/app/schemas/` based on the schemas defined in the unified **OpenAPI specification**, ensuring they match exactly with **field types** and **validations**.

**Prompt:**

> Generate a script named `generate_schemas.py` that creates **Pydantic models** in `/service/app/schemas/` corresponding to the schemas defined in `/service/openapi/merged_openapi.yml`. Use the **OpenAPI parser** from `/service/app/core/openapi_parser.py` to extract the necessary information.

### 7. generate_api_routes.py

**Description:**

This script creates **FastAPI route files** in `/service/app/api/routes/` based on the unified **OpenAPI specification**, including **route decorators**.

**Prompt:**

> Generate a script named `generate_api_routes.py` that creates **route files** in `/service/app/api/routes/` with **FastAPI endpoints** as per `/service/openapi/merged_openapi.yml`. Use the **OpenAPI parser** to extract the relevant information for each endpoint, ensuring that paths, methods, parameters, and response models match the specification.

### 8. setup_mock_server.py

**Description:**

This master script executes all the previously generated Python scripts in the correct order to set up the **Mock Server project**.

**Prompt:**

> Generate a script named `setup_mock_server.py` that executes all the previously generated Python scripts in the correct order to set up the **Mock Server project**. Ensure that dependencies are handled correctly.

### 9. run_setup.sh

**Description:**

This **shell script** automates the **Docker build** and **setup process** by building and running the Docker container and executing the setup Python script within the container.

**Prompt:**

> Generate a shell script named `run_setup.sh` that builds the Docker image using `docker build -t fountainai-mock .`, runs the Docker container, and executes `python scripts/setup_mock_server.py` inside the container. Include echo statements to inform the user of each step.

---

## Execution Order

1. **merge_openapi.py** (Manually executed to generate `merged_openapi.yml`)
2. **generate_dockerfile.py**
3. **create_directory_structure.py**
4. **generate_minimal_main.py**
5. **generate_openapi_parser.py**
6. **generate_schemas.py**
7. **generate_api_routes.py**
8. **setup_mock_server.py**
9. **run_setup.sh**

This order ensures that the **unified OpenAPI specification** is generated first and that the **OpenAPI parser** and **Pydantic schemas** are established before generating API routes, which depend on them.

---

## Workflow Details

### Step 1: Merge OpenAPI Specifications

Before setting up the Mock Server, merge the individual OpenAPI files into a unified specification using `merge_openapi.py`.

**Command:**

```bash
python merge_openapi.py merge-openapi --input-directory "./openapi" --output-file "./openapi/merged_openapi.yml" --validate --verbose
```

- **`--input-directory`**: Directory containing individual OpenAPI files (`./openapi`).
- **`--output-file`**: Output path for the merged OpenAPI file (`./openapi/merged_openapi.yml`).
- **`--validate`**: Validates the merged OpenAPI specification.
- **`--verbose`**: Provides detailed output during the merging process.

### Step 2: Generate the Dockerfile

Run `generate_dockerfile.py` to create the `Dockerfile`.

```bash
python scripts/generate_dockerfile.py
```

### Step 3: Create Directory Structure

Run `create_directory_structure.py` to set up the project directories and initial files.

```bash
python scripts/create_directory_structure.py
```

### Step 4: Generate Minimal Main

Run `generate_minimal_main.py` to create a minimal `main.py`.

```bash
python scripts/generate_minimal_main.py
```

### Step 5: Generate OpenAPI Parser

Run `generate_openapi_parser.py` to create the OpenAPI parser module.

```bash
python scripts/generate_openapi_parser.py
```

### Step 6: Generate Schemas

Run `generate_schemas.py` to create Pydantic models based on the merged OpenAPI specification.

```bash
python scripts/generate_schemas.py
```

### Step 7: Generate API Routes

Run `generate_api_routes.py` to create FastAPI route files as per the merged OpenAPI specification.

```bash
python scripts/generate_api_routes.py
```

### Step 8: Setup Mock Server

Run `setup_mock_server.py` to orchestrate the execution of all the above scripts (if not run individually).

```bash
python scripts/setup_mock_server.py
```

### Step 9: Build and Run the Docker Container

Use `run_setup.sh` to automate the Docker build and setup process.

```bash
chmod +x run_setup.sh
./run_setup.sh
```

---

## Notes on Workflow

### Prerequisites

- **Python 3.9+** must be installed on your local machine.
- **Docker** must be installed on your local machine.

### Clone the Repository

Clone the repository and navigate to the `/service` directory:

```bash
git clone https://github.com/Contexter/FountainAI-Mock.git
cd FountainAI-Mock/service
```

### Merge OpenAPI Specifications

Ensure that you have all individual OpenAPI files in the `/service/openapi/` directory.

Run the `merge_openapi.py` script as described in **Step 1** to generate the unified OpenAPI specification.

### Develop and Test

With the **Docker container** running, you can engage in development and testing activities. **Editing code locally** will reflect changes inside the container due to **volume mounting**.

- **Access the application** by visiting [http://localhost:8000](http://localhost:8000).
- **API Documentation**: The interactive API docs are available at [http://localhost:8000/docs](http://localhost:8000/docs).
- **Run tests inside the container** (if tests are implemented):

  ```bash
  docker exec -it fountainai-mock-container bash
  pytest
  ```

### Stop the Docker Container

When development is complete, you can stop the Docker container with:

```bash
docker stop fountainai-mock-container
```

---

## Script Execution Details

### merge_openapi.py

This script is critical as it generates the unified OpenAPI specification that serves as the foundation for the Mock Server.

**References:**

- **Script:** [`merge_openapi.py`](https://github.com/Contexter/FountainAI-Mock/blob/main/merge_openapi.py)
- **Documentation:** [Comprehensive Documentation and Tutorial for `merge_openapi.py`](https://github.com/Contexter/FountainAI/blob/main/openAPI/v4/merge/Comprehensive%20Documentation%20and%20Tutorial%20for%20merge_openapi.py.md)

### setup_mock_server.py

This master script ensures that all necessary scripts are executed in the correct sequence, handling dependencies appropriately.

**Execution Order within `setup_mock_server.py`:**

1. `generate_dockerfile.py`
2. `create_directory_structure.py`
3. `generate_minimal_main.py`
4. `generate_openapi_parser.py`
5. `generate_schemas.py`
6. `generate_api_routes.py`

### run_setup.sh

This shell script automates the Docker build and setup process.

**Script Steps:**

1. **Build the Docker Image:**

   ```bash
   docker build -t fountainai-mock .
   ```

2. **Run the Docker Container:**

   ```bash
   docker run -d --name fountainai-mock-container -p 8000:8000 -v "$(pwd)":/service fountainai-mock
   ```

   - The `-v "$(pwd)":/service` option mounts the current directory into the container.

3. **Wait for the Container to Initialize:**

   Include a short sleep or health check.

4. **Execute Setup Script Inside the Container:**

   ```bash
   docker exec -it fountainai-mock-container python scripts/setup_mock_server.py
   ```

5. **Provide Echo Statements:**

   Inform the user about each step's progress and completion status.

**Sample `run_setup.sh`:**

```bash
#!/bin/bash

echo "Building the Docker image..."
docker build -t fountainai-mock .

echo "Running the Docker container..."
docker run -d --name fountainai-mock-container -p 8000:8000 -v "$(pwd)":/service fountainai-mock

echo "Waiting for the container to initialize..."
sleep 5  # Adjust the sleep time as needed

echo "Executing setup script inside the container..."
docker exec -it fountainai-mock-container python scripts/setup_mock_server.py

echo "Setup completed successfully! Access the application at http://localhost:8000"
```

Ensure the script is **executable**:

```bash
chmod +x run_setup.sh
```

---

## Summary

This development plan provides a structured approach to setting up the **FountainAI Mock Server API** based on the unified **OpenAPI specification** generated by `merge_openapi.py`. By focusing on essential components and utilizing the merged specification as the source of truth, we ensure consistency between the documentation and the implementation.

**Key Features:**

- **Unified OpenAPI Specification:** The merged OpenAPI file (`merged_openapi.yml`) serves as the definitive guide for generating Pydantic schemas and API routes, ensuring consistency.

- **Modular Script-Based Setup:** The use of modular scripts allows for easy customization and maintenance.

- **Dockerized Environment:** The Docker setup enables a consistent development environment, simplifying dependency management and deployment.

- **Simplified Architecture:** By omitting unnecessary components like database integrations and external service synchronizations, the focus remains on delivering a functional mock server that meets the specified requirements.

**Next Steps:**

- **Generate the Unified OpenAPI Specification:** Use `merge_openapi.py` to merge individual OpenAPI files.

- **Generate the Necessary Scripts:** Run the scripts in the specified order to set up your Mock Server.

- **Start Developing:** With the environment set up, you can begin developing and testing your endpoints as defined in the unified OpenAPI specification.

- **Iterate and Refine:** Use the modular nature of the setup to add additional features or make adjustments as needed.

---

**Note:** Ensure that all paths and commands are correctly adjusted to match your specific environment and directory structure. The provided commands assume you are running them from the `/service` directory of your project within the [FountainAI-Mock repository](https://github.com/Contexter/FountainAI-Mock).
